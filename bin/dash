#!/bin/bash

# â”€â”€â”€ Colors & Symbols â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
R='\033[0m'
DIM='\033[2m'
BOLD='\033[1m'
CYAN='\033[36m'
GREEN='\033[32m'
YELLOW='\033[33m'
MAGENTA='\033[35m'
BLUE='\033[34m'
RED='\033[31m'
WHITE='\033[37m'

# â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
divider() {
  echo -e "${DIM}$(printf '%.0sâ”€' {1..56})${R}"
}

section() {
  echo ""
  echo -e "  ${BOLD}${CYAN}$1${R}"
  divider
}

row() {
  printf "  ${DIM}%-14s${R} %b\n" "$1" "$2"
}

empty_state() {
  echo -e "  ${DIM}$1${R}"
}

# â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clear
echo ""
echo -e "${BOLD}${MAGENTA}  â”Œâ”€â”â”Œâ”€â”â”Œâ” â”¬â”Œâ”€â”Œâ”€â”â”¬  â”¬â”Œâ”â”Œâ”Œâ”¬â”${R}"
echo -e "${BOLD}${MAGENTA}  â””â”€â”â”œâ”¤ â”œâ”´â”â”œâ”´â”â”‚ â”‚â”‚  â”‚â”‚â”‚â”‚ â”‚â”‚${R}"
echo -e "${BOLD}${MAGENTA}  â””â”€â”˜â””â”€â”˜â””â”€â”˜â”´ â”´â””â”€â”˜â”´â”€â”˜â”´â”˜â””â”˜â”€â”´â”˜${R}"
echo ""
divider

# â”€â”€â”€ My Open PRs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
section "â¬¡  My Pull Requests"

prs=$(gh pr list --author="@me" --json number,title,reviewDecision --limit 5 2>/dev/null)

if [ -z "$prs" ] || [ "$prs" = "[]" ]; then
  empty_state "No open PRs â€” go ship something!"
else
  echo "$prs" | jq -r '.[] | "\(.number)|\(.title)|\(.reviewDecision)"' 2>/dev/null | while IFS='|' read -r number title decision; do
    title=$(echo "$title" | head -c 34)
    case "$decision" in
      APPROVED)           badge="${GREEN}âœ“ approved${R}" ;;
      CHANGES_REQUESTED)  badge="${RED}âœ— changes${R}" ;;
      REVIEW_REQUIRED)    badge="${YELLOW}â— review${R}" ;;
      *)                  badge="${DIM}â—‹ pending${R}" ;;
    esac
    printf "  ${BLUE}#%-5s${R} %-34s %b\n" "$number" "$title" "$badge"
  done
fi

# â”€â”€â”€ PRs to Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
section "ğŸ‘€  Review Requests"

review_prs=$(gh pr list --search "review-requested:@me" --json number,title,author --limit 5 2>/dev/null)

if [ -z "$review_prs" ] || [ "$review_prs" = "[]" ]; then
  empty_state "No reviews waiting â€” inbox zero!"
else
  echo "$review_prs" | jq -r '.[] | "\(.number)|\(.title)|\(.author.login)"' 2>/dev/null | while IFS='|' read -r number title author; do
    title=$(echo "$title" | head -c 34)
    printf "  ${BLUE}#%-5s${R} %-34s ${DIM}by %s${R}\n" "$number" "$title" "$author"
  done
fi

# â”€â”€â”€ Jira â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
section "ğŸ“‹  Jira"

jira_items=$(acli jira workitem search --jql "assignee = currentUser() AND status in ('In Progress', 'Test', 'Selected for Dev', 'On Deck', 'Blocked')" --fields "key,summary,status" --limit 5 --json 2>/dev/null)

if [ -z "$jira_items" ] || [ "$jira_items" = "[]" ]; then
  empty_state "Nothing assigned to you â€” pick up a ticket!"
else
  echo "$jira_items" | jq -r '.[] | "\(.key)|\(.fields.summary)|\(.fields.status.name)"' 2>/dev/null | while IFS='|' read -r key summary status; do
    summary=$(echo "$summary" | head -c 34)
    case "$status" in
      "In Progress")       badge="${YELLOW}â— in progress${R}" ;;
      "Test")              badge="${CYAN}â— test${R}" ;;
      "Selected for Dev")  badge="${BLUE}â—† selected${R}" ;;
      "On Deck")           badge="${DIM}â—‹ on deck${R}" ;;
      "Blocked")           badge="${RED}âœ— blocked${R}" ;;
      *)                   badge="${DIM}â—‹ ${status}${R}" ;;
    esac
    printf "  ${MAGENTA}%-7s${R} %-34s %b\n" "$key" "$summary" "$badge"
  done
fi

# â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo -e "  ${DIM}$(date '+%A, %B %d Â· %H:%M')${R}"
echo ""
